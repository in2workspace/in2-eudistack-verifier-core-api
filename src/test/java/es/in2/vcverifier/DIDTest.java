package es.in2.vcverifier;

import com.nimbusds.jose.*;
import com.nimbusds.jose.crypto.ECDSASigner;
import com.nimbusds.jose.crypto.ECDSAVerifier;
import com.nimbusds.jose.crypto.bc.BouncyCastleProviderSingleton;
import com.nimbusds.jose.jwk.Curve;
import com.nimbusds.jose.jwk.ECKey;
import com.nimbusds.jwt.SignedJWT;
import es.in2.vcverifier.exception.JWTVerificationException;
import es.in2.vcverifier.util.UVarInt;
import org.bitcoinj.base.Base58;
import org.bouncycastle.jcajce.provider.asymmetric.ec.BCECPublicKey;
import org.bouncycastle.jce.ECNamedCurveTable;
import org.bouncycastle.jce.spec.*;
import org.bouncycastle.math.ec.ECCurve;
import org.bouncycastle.math.ec.custom.sec.SecP256R1Curve;
import org.json.JSONObject;
import org.junit.jupiter.api.Test;
import org.springframework.security.oauth2.jwt.Jwt;
import org.springframework.security.oauth2.jwt.JwtDecoder;
import org.springframework.security.oauth2.jwt.NimbusJwtDecoder;

import java.math.BigInteger;
import java.security.*;
import java.security.interfaces.ECPrivateKey;
import java.security.interfaces.ECPublicKey;
import java.security.spec.ECPoint;
import java.security.spec.InvalidKeySpecException;
import java.security.spec.X509EncodedKeySpec;
import java.util.Arrays;
import java.util.List;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.springframework.test.util.AssertionErrors.assertTrue;

class DIDTest {

    // https://www.scottbrady91.com/tools/jwt

    @Test
    void generateDid() throws NoSuchAlgorithmException, InvalidKeySpecException, JOSEException {
        ECKey ecKey = generateECKeyAndDidKey();
        System.out.println("Private Key - d: " + ecKey.getD() + " x: " + ecKey.getX() + " y: " + ecKey.getY());
        String didKey = getDidKeyFromPublicKey(ecKey.toECPublicKey());
        // Generate a JWT to test M2M
        ECKey ecPublicJWK = ecKey.toPublicJWK();
        JWSSigner signer = new ECDSASigner(ecKey);
        Payload payload = new Payload(Map.of(
                "iss", didKey,
                "iat", 1725951134,
                "exp", 1760079134,
                "aud", "http://localhost:9000",
                "sub", didKey,
                "vp_token", "LEARCredentialMachine in JWT",
                "jti", "6bede557-46d3-4a6a-837d-2080e4c38222"
        ));
        JWSObject jwsObject = new JWSObject(
                new JWSHeader.Builder(JWSAlgorithm.ES256).keyID(ecKey.getKeyID()).build(),
                payload);
        // Compute the EC signature
        jwsObject.sign(signer);
        // Serialize the JWS to compact form
        String jwtBearer = jwsObject.serialize();
        System.out.println("JWT: " + jwtBearer);
        // The recipient creates a verifier with the public EC key
        JWSVerifier verifier = new ECDSAVerifier(ecPublicJWK);
        // Verify the EC signature
        assertTrue("ES256 signature verified", jwsObject.verify(verifier));
        assertEquals(payload.toString(), jwsObject.getPayload().toString());
    }

    @Test
    void generateJWT() throws NoSuchAlgorithmException, InvalidKeySpecException, JOSEException {
        Map<String, Object> vp = Map.of(
                "@context", List.of("https://www.w3.org/2018/credentials/v1"),
                "holder", "did:key:zDnaepbQkLnywX4GHsnpTuGQkBHtJ4UnGM97ts7XuM273L1ih",
                "id", "urn:uuid:41acada3-67b4-494e-a6e3-e0966449f25d",
                "type", List.of("VerifiablePresentation"),
                "verifiableCredential", List.of(
                        "eyJhbGciOiJSUzI1NiIsImN0eSI6Impzb24iLCJraWQiOiJNSUhRTUlHM3BJRzBNSUd4TVNJd0lBWURWUVFEREJsRVNVZEpWRVZNSUZSVElFRkVWa0ZPUTBWRUlFTkJJRWN5TVJJd0VBWURWUVFGRXdsQ05EYzBORGMxTmpBeEt6QXBCZ05WQkFzTUlrUkpSMGxVUlV3Z1ZGTWdRMFZTVkVsR1NVTkJWRWxQVGlCQlZWUklUMUpKVkZreEtEQW1CZ05WQkFvTUgwUkpSMGxVUlV3Z1QwNGdWRkpWVTFSRlJDQlRSVkpXU1VORlV5QlRURlV4RXpBUkJnTlZCQWNNQ2xaaGJHeGhaRzlzYVdReEN6QUpCZ05WQkFZVEFrVlRBaFJraVFqbVlLNC95SzlIbGdrVURVNHoyZEo5OWc9PSIsIng1dCNTMjU2IjoidEZHZ19WWHVBdUc3NTZpUG52aWVTWjQ2ajl6S3VINW5TdmJKMHA5cFFaUSIsIng1YyI6WyJNSUlIL1RDQ0JlV2dBd0lCQWdJVVpJa0k1bUN1UDhpdlI1WUpGQTFPTTluU2ZmWXdEUVlKS29aSWh2Y05BUUVOQlFBd2diRXhJakFnQmdOVkJBTU1HVVJKUjBsVVJVd2dWRk1nUVVSV1FVNURSVVFnUTBFZ1J6SXhFakFRQmdOVkJBVVRDVUkwTnpRME56VTJNREVyTUNrR0ExVUVDd3dpUkVsSFNWUkZUQ0JVVXlCRFJWSlVTVVpKUTBGVVNVOU9JRUZWVkVoUFVrbFVXVEVvTUNZR0ExVUVDZ3dmUkVsSFNWUkZUQ0JQVGlCVVVsVlRWRVZFSUZORlVsWkpRMFZUSUZOTVZURVRNQkVHQTFVRUJ3d0tWbUZzYkdGa2IyeHBaREVMTUFrR0ExVUVCaE1DUlZNd0hoY05NalF3TmpJeE1EWTFOelUwV2hjTk1qY3dOakl4TURZMU56VXpXakNCcXpFVk1CTUdBMVVFQXd3TVdrVlZVeUJQVEVsTlVFOVRNUmd3RmdZRFZRUUZFdzlKUkVORlZTMDVPVGs1T1RrNU9WQXhEVEFMQmdOVkJDb01CRnBGVlZNeEVEQU9CZ05WQkFRTUIwOU1TVTFRVDFNeEh6QWRCZ05WQkFzTUZrUlBUVVVnUTNKbFpHVnVkR2xoYkNCSmMzTjFaWEl4R0RBV0JnTlZCR0VNRDFaQlZFVlZMVUk1T1RrNU9UazVPVEVQTUEwR0ExVUVDZ3dHVDB4SlRWQlBNUXN3Q1FZRFZRUUdFd0pGVlRDQ0FpSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnSVBBRENDQWdvQ2dnSUJBTERkMGNGZ3A2dzdqV0dVNW9OU3hBWXVQejlodzMwWHdtQ3AxTldieTh4STBPN2I5blUwT0JwTTR1ZWRDKzdoSDd5Uk51ek9VTzF3S1IwZkpJcVkyc3picTExblZwNnNDTWl1eVlzb0d4NXJNQ3RMM3Y5TFBFdnU2MXhER0xRYVlBZnF0ZjVhTXdHL0QvOTQzdnUvTzJYZWQyc1VOYnIrZDFIYjZlUHVIRzU5ZS9YekRraTBuZUtPOHJSUllRakVlSzhDek50Z3N6NUN4cFBtZ3g5ZUVqMEYwZTEzRjErbzB5VGwzYUhET1FvVUErUWhjQzRYc2UzQkN0TXZnRTl1WTdWKzNlRUhFR2h5bUJjeldtbHVYeGpRMjJDZlREWFZvKzFEa0U3SWhkZU9pdGRBa2txT056VVRzVGwxa2gwTlByNDJaall3K1JaK3EybTI4QTYvbTVEbzBUdGlIaDFML2dHZkVaZjhBRzJUWWt6alhkSGEvdWRFY1hrTmlBeVpGZEo3RDlIYzZwZUhXdlFDZ2VES1dVakVtcExiMkx1c2pqVmRTYTdRc2hZbHZYS3I2b3FRcW5qZ0tOWTMwSXBvOTF2SUxZQ243MTJHRHlMR0x1ZEpxUXI0L0s5Y2cwR21sRUI1OGU4ZHdKRlhXK1o2c3lodW9CaEZESkRZNE9oZnFYeVQ2bnNPOEJ1WVl3YmFMQkFIZGprcmt5UUdpTFJDVk5oTDlBeHdBdXlhRkhjeU5ieXo5RDZ0ZUVXSThSWWFMN2JJNStpa0VBVkVJVWdnZlUxK1JCaFQwa3dDbmVTSk5BYUorSnN2WjA1czFNdTFhakZMWVhZMHI5clVlb1cyMkJDSmJuVXEyYjEzdS92dS9hRlZjTkpMdXE3OXp1YWZJUytybXQ2NUFqN3ZBZ01CQUFHamdnSVBNSUlDQ3pBTUJnTlZIUk1CQWY4RUFqQUFNQjhHQTFVZEl3UVlNQmFBRklJVG9hTUNsTTVpRGVBR3RqZFdRWEJjUmE0ck1IUUdDQ3NHQVFVRkJ3RUJCR2d3WmpBK0JnZ3JCZ0VGQlFjd0FvWXlhSFIwY0RvdkwzQnJhUzVrYVdkcGRHVnNkSE11WlhNdlJFbEhTVlJGVEZSVFVWVkJURWxHU1VWRVEwRkhNUzVqY25Rd0pBWUlLd1lCQlFVSE1BR0dHR2gwZEhBNkx5OXZZM053TG1ScFoybDBaV3gwY3k1bGN6Q0J3QVlEVlIwZ0JJRzRNSUcxTUlHeUJnc3JCZ0VFQVlPblVRb0RDekNCb2pBL0JnZ3JCZ0VGQlFjQ0FSWXphSFIwY0hNNkx5OXdhMmt1WkdsbmFYUmxiSFJ6TG1WekwyUndZeTlFU1VkSlZFVk1WRk5mUkZCRExuWXlMakV1Y0dSbU1GOEdDQ3NHQVFVRkJ3SUNNRk1NVVVObGNuUnBabWxqWVdSdklHTjFZV3hwWm1sallXUnZJR1JsSUdacGNtMWhJR1ZzWldOMGNtOXVhV05oSUdGMllXNTZZV1JoSUdSbElIQmxjbk52Ym1FZ1ptbHphV05oSUhacGJtTjFiR0ZrWVRBUEJna3JCZ0VGQlFjd0FRVUVBZ1VBTUIwR0ExVWRKUVFXTUJRR0NDc0dBUVVGQndNQ0JnZ3JCZ0VGQlFjREJEQkNCZ05WSFI4RU96QTVNRGVnTmFBemhqRm9kSFJ3T2k4dlkzSnNNUzV3YTJrdVpHbG5hWFJsYkhSekxtVnpMMFJVVTFGMVlXeHBabWxsWkVOQlJ6RXVZM0pzTUIwR0ExVWREZ1FXQkJSSnRva0hPWEYyMzVVSktZM0tPQVdhZ1NHZExEQU9CZ05WSFE4QkFmOEVCQU1DQnNBd0RRWUpLb1pJaHZjTkFRRU5CUUFEZ2dJQkFGME1nS1NHWXNiaURrUTVCQmZLc1VGWnpBd2xzTDhrRTYzUHlKMFBMajVzT2VUMEZMWTVJeTVmY0U2NmcwWEozSWsvUG0vYTFiK0hCd2l0bkx3ZGRKbVJwWm9ta09RSWxaYXRUQk9tQTlUd2M4OE5MdU5TdTdVM0F5cXV0akRSbFVDOFpGeWRDY1pUalF0bVVIM1FlU0d4RDYvRy82T0JGK2VVY3o1QTVkenJIMGtKNkQrYTQ3MjBjYitkZ01ycTA0OTBVbTVJcExReXRuOG5qSjNSWWtINnhVNmoxdEJpVmsrTVJ4TUZ6bUoxSlpLd1krd2pFdklidlZrVGt0eGRLWVFubFhGL1g2UlhnZjJ0MEJlK0YyRDU0R3pYcWlxeGMvRVVZM3k1Ni9rTUk1OW5ibGdia1ZPYTZHYVd3aUdPNnk1R3h2MVFlUmxVd2Z5TGZRRFR4Ykh6eXBrUysrcG55NXl2OU5kVytQR2loUVZubGFrdkFUS010M1B4WVZyYU91U3NWQVQyVVlVLy9sRGNJWU44Sk94NDB5amVubVVCci8yWE1yeDd2SzhpbkU1SzI0cmg4OXNZUVc3ZkZLM2RmQTRpeTEzblpRc1RzdWlEWVdBZWV6cTlMU3RObE9ncnFxd0RHRDdwLzRzbFh2RlhwTkxtcjlYaXVWRUtXQ0dmSXJnY0tPck5qV3hRREMwV1NsdGtNUFZTZzVrTlMwTW1GYmM0OHB3WXlmR3o2TkUvSmFVNVFzcXdBNnRtR3FLanhOUXJKRGptYXBheFltL3RYSjZhblhjY2sySWVudDRlc241UDhIdE1uK0wzQWQ0RFF4NWlkVWhPQmtsb1NWVlR2dWUvOXgrZTRQWXJDVHNiT3pBa1VtRTl3amFOSStLNW9jWmFvVEhDQTVDNyIsIk1JSUdWVENDQkQyZ0F3SUJBZ0lVRTZwM1hXYXFWOHdpZFQwR2dGZWNxOU1iSGw0d0RRWUpLb1pJaHZjTkFRRU5CUUF3Z2JFeElqQWdCZ05WQkFNTUdVUkpSMGxVUlV3Z1ZGTWdRVVJXUVU1RFJVUWdRMEVnUnpJeEVqQVFCZ05WQkFVVENVSTBOelEwTnpVMk1ERXJNQ2tHQTFVRUN3d2lSRWxIU1ZSRlRDQlVVeUJEUlZKVVNVWkpRMEZVU1U5T0lFRlZWRWhQVWtsVVdURW9NQ1lHQTFVRUNnd2ZSRWxIU1ZSRlRDQlBUaUJVVWxWVFZFVkVJRk5GVWxaSlEwVlRJRk5NVlRFVE1CRUdBMVVFQnd3S1ZtRnNiR0ZrYjJ4cFpERUxNQWtHQTFVRUJoTUNSVk13SGhjTk1qUXdOVEk1TVRJd01EUXdXaGNOTXpjd05USTJNVEl3TURNNVdqQ0JzVEVpTUNBR0ExVUVBd3daUkVsSFNWUkZUQ0JVVXlCQlJGWkJUa05GUkNCRFFTQkhNakVTTUJBR0ExVUVCUk1KUWpRM05EUTNOVFl3TVNzd0tRWURWUVFMRENKRVNVZEpWRVZNSUZSVElFTkZVbFJKUmtsRFFWUkpUMDRnUVZWVVNFOVNTVlJaTVNnd0pnWURWUVFLREI5RVNVZEpWRVZNSUU5T0lGUlNWVk5VUlVRZ1UwVlNWa2xEUlZNZ1UweFZNUk13RVFZRFZRUUhEQXBXWVd4c1lXUnZiR2xrTVFzd0NRWURWUVFHRXdKRlV6Q0NBaUl3RFFZSktvWklodmNOQVFFQkJRQURnZ0lQQURDQ0Fnb0NnZ0lCQU1PUWFCSkdVbkt2eDQwS1pENkVldVlNU3hBQWNjc0h5TkpXNnFNbms2N25PUEhCOTdnalJnbnNKeGVoVThRUGd4aE9iaHE3a1djMDJ2VzhuUUlTMnF5NzBIalcreTZJTWFPdGx5a3NvTlhPY3pRb1pDblZxQklpL2tEc09oRlYxcmNFWGFpQkVUL051SXJTS3ZHWUVJZHpBOUphcVlkZmkvSlEvbHJZYXlEZlAzZDczaHN1cStsSWpOMGQ5aCtwS2NZd0wvbUlJYksvY1F3bGxBVW1kZHJBdzlXRW1xa2wrNVJ1RFdxcGxEV2hodnBHSkZQWHQ0UnFLZ2FhVk41VFV3UzJPR0pTTnFDczZaSSthU2RuZVRnQ3FxUS8vODNoTjlRc20wbUIwTjhOTzlscVNwQ21QT2pZR09UcDdJazhpQjd0ZXgxT055ZVhNSGw5ektEY2lxVjE2MlpScEd0Sm0ycnU4NklVQ1NqUGxzcVRYTW5XMTQyTUt1Z3NXM1g3MVkwcXgzRFJVKzNMd2djSnFhTzFZLzlEMmtRRVFKM3Y1WmVpR1FhdVJXcWZqakFrRVJnaCs4bTNXWFhMcm56QW9GaHJRZGxCYTFRNjFJMlVxYnF4YkEwZFM5TGRPdDUrbkZGVlptK0U3QUFlVnlyOFVqVldUZEpRdlROM3VxMFZrTDBuMnBxMDMrSGI0Z1BSOHZycEQ3OUp5bHlVY0lSMFFOSWdNdEVGZTRlRkoraUM5K21iZU9qekhRa2w4Wkc1NTFYMkt5NnNsM09PbmY5M1hlZFFEMHZHMHJDWXBSR1orNTBrMDVqbHVLelJqY2lxQUNnTEhDRlNwY0x5QlNLZ3JYY0EwcWxwWURUSWJleDg5VHZSR1kxbm93ckM1bG1HTlQ4akpyeENZT1lEQWdNQkFBR2pZekJoTUE4R0ExVWRFd0VCL3dRRk1BTUJBZjh3SHdZRFZSMGpCQmd3Rm9BVWdoT2hvd0tVem1JTjRBYTJOMVpCY0Z4RnJpc3dIUVlEVlIwT0JCWUVGSUlUb2FNQ2xNNWlEZUFHdGpkV1FYQmNSYTRyTUE0R0ExVWREd0VCL3dRRUF3SUJoakFOQmdrcWhraUc5dzBCQVEwRkFBT0NBZ0VBSkdRS3JaMlUzSi9TcEdoUDd6V2p2d2VCWHhqVzV1U2R4MFY3bXd2NG12QzJWbEMxVHZ4RW41eVZuZEVVQ3BsR3AvbTBTM0EwN0J0UFoyNFpTdVJ3K21JcHRCbUNoYm5VMXZqMkJGcEZGVGhwc1FKRzBrRGpEMjNIbzZwM1J0TXJpYjhJaTBSbm9VYndwUDVOMkxpZU9idW9kOU9TOXEzTWdDbGh5OUY5OW1PV3ZEL3E1dkNWbyt1TFdadVE0YWN1VFROeGE1REh5aWpnQitHR28yT2hIbGRyU3BwK0xSZ1U1ZmtOS0cwTHpobElFR2RFQmFsMHB1Wi8rUXF0U3JyTERNVDRYUEtXTUo2Z3BzcjNsWGZiYTBFbDdiYi83NTZ0TVlBYlh6bW5ra1VxZGlPSTU3clZERlQ5Rkp4alZnbzVvVzhYT0tHU0xxTUgzMVhpSkNOb0g1ckpZOFZRM1ptTVN1aDk3a0FBaFh1RkliUVo3RnJrRjJ5K0dzS3BiMGE5WlVxRkJySmx6SHhDS2w4U1NUd2ZHRGdjcGVQWnhVSUlnUFBjSTRvWHdSb0IwSGJ0NTRJclJvRzdrV2s2OGdYMmNqS1YwWXRIbVZoRUVGcjNkaVpmTzdtQVRBNTRzTFpYOW4xbG9zbmY5eHJlRXpkRVlXYnlHVGhVd2wzM01QNlhMYUZSUGRiblFzaGJyb2VwemcrbmtzVTVWVksyWlpGSVdWWTZnK1JoSUNYVmRocWtCcE5tK2VLMCt3VUNBMXRYWXlSS29TVVZwTUZTQVpobnN5VWVaemFtUEhEZTRHa1RhbU1LNHFmWEtRT2I3RXRXVVdoNWZvVlN6YXF5dkZwcFU0Vk1wL2dLclBZSEQ2YldySEo1dkMvQjdXci9hUHRoTmtnWEZNR01yUjA9Il0sInR5cCI6Impvc2UiLCJzaWdUIjoiMjAyNC0wOS0xN1QxMjoyMTozMloiLCJjcml0IjpbInNpZ1QiXX0.eyJzdWIiOiJkaWQ6a2V5OnpEbmFlVjJuOW5LOFVhYnZjZ2FhOVhkSmtkYnFVYWhMTHBidDRXcVM4M0Y4cFBDdjciLCJuYmYiOjE3MjY1NzU2MDgsImlzcyI6ImRpZDplbHNpOlZBVEVTLVEwMDAwMDAwSiIsImV4cCI6MTcyOTE2NzYwOCwiaWF0IjoxNzI2NTc1NjA4LCJ2YyI6eyJAY29udGV4dCI6WyJodHRwczovL3d3dy53My5vcmcvbnMvY3JlZGVudGlhbHMvdjIiLCJodHRwczovL2RvbWUtbWFya2V0cGxhY2UuZXUvMjAyMi9jcmVkZW50aWFscy9sZWFyY3JlZGVudGlhbC92MSJdLCJpZCI6ImE5NmY0ZjA0LTI1OGYtNDM2Ny04YTIwLWQyOTk4ZTljYzc1OSIsInR5cGUiOlsiTEVBUkNyZWRlbnRpYWxFbXBsb3llZSIsIlZlcmlmaWFibGVDcmVkZW50aWFsIl0sImNyZWRlbnRpYWxTdWJqZWN0Ijp7Im1hbmRhdGUiOnsiaWQiOiJjMjk2NTA1OS1jMTkyLTRlMzYtOTU0NS02ZTY1OWViNTdhYTgiLCJsaWZlX3NwYW4iOnsiZW5kX2RhdGVfdGltZSI6IjIwMjQtMTAtMTdUMTI6MjA6MDguNDA4NTE3MDg0WiIsInN0YXJ0X2RhdGVfdGltZSI6IjIwMjQtMDktMTdUMTI6MjA6MDguNDA4NTE3MDg0WiJ9LCJtYW5kYXRlZSI6eyJpZCI6ImRpZDprZXk6ekRuYWVWMm45bks4VWFidmNnYWE5WGRKa2RicVVhaExMcGJ0NFdxUzgzRjhwUEN2NyIsImVtYWlsIjoicnViZW4ubW9kYW1pb0BpbjIuZXMiLCJmaXJzdF9uYW1lIjoiUnViZW4iLCJsYXN0X25hbWUiOiJNb2RhbWlvIEdhcmNpYSIsIm1vYmlsZV9waG9uZSI6IiszNCA2NDAwOTk5OTkifSwibWFuZGF0b3IiOnsiY29tbW9uTmFtZSI6IlpFVVMgT0xJTVBPUyIsImNvdW50cnkiOiJFUyIsImVtYWlsQWRkcmVzcyI6ImRvbWVzdXBwb3J0QGluMi5lcyIsIm9yZ2FuaXphdGlvbiI6IklOMiIsIm9yZ2FuaXphdGlvbklkZW50aWZpZXIiOiJWQVRFUy1RMDAwMDAwMEoiLCJzZXJpYWxOdW1iZXIiOiJJRENFVS05OTk5OTk5OVAifSwicG93ZXIiOlt7ImlkIjoiM2E3YmMwMDEtMGNkNi00MWNjLTk2YmQtNjUwNzQ1ZjNjMWM4IiwidG1mX2FjdGlvbiI6IkV4ZWN1dGUiLCJ0bWZfZG9tYWluIjpudWxsLCJ0bWZfZnVuY3Rpb24iOiJPbmJvYXJkaW5nIiwidG1mX3R5cGUiOiJEb21haW4ifSx7ImlkIjoiYjE4N2JmMjgtZmRhMC00OTRiLWE1YjYtNzQ5MzNjNGUwOTUwIiwidG1mX2FjdGlvbiI6WyJDcmVhdGUiLCJVcGRhdGUiXSwidG1mX2RvbWFpbiI6bnVsbCwidG1mX2Z1bmN0aW9uIjoiUHJvZHVjdE9mZmVyaW5nIiwidG1mX3R5cGUiOiJEb21haW4ifSx7ImlkIjoiY2FmNWJhNTMtMWM2My00ZjE2LTgwMjUtZjVmOWE2NjFkYjk0IiwidG1mX2FjdGlvbiI6WyJQcm92aWRlciJdLCJ0bWZfZG9tYWluIjpudWxsLCJ0bWZfZnVuY3Rpb24iOiJEb21lUGxhdGZvcm0iLCJ0bWZfdHlwZSI6IkRvbWFpbiJ9XSwic2lnbmVyIjp7ImNvbW1vbk5hbWUiOiJaRVVTIE9MSU1QT1MiLCJjb3VudHJ5IjoiRVUiLCJlbWFpbEFkZHJlc3MiOiJkb21lc3VwcG9ydEBpbjIuZXMiLCJvcmdhbml6YXRpb24iOiJPTElNUE8iLCJvcmdhbml6YXRpb25JZGVudGlmaWVyIjoiVkFURVUtQjk5OTk5OTk5Iiwic2VyaWFsTnVtYmVyIjoiSURDRVUtOTk5OTk5OTlQIn19fSwiZXhwaXJhdGlvbkRhdGUiOiIyMDI0LTEwLTE3VDEyOjIwOjA4LjQwODUxNzA4NFoiLCJpc3N1YW5jZURhdGUiOiIyMDI0LTA5LTE3VDEyOjIwOjA4LjQwODUxNzA4NFoiLCJpc3N1ZXIiOiJkaWQ6ZWxzaTpWQVRFUy1RMDAwMDAwMEoiLCJ2YWxpZEZyb20iOiIyMDI0LTA5LTE3VDEyOjIwOjA4LjQwODUxNzA4NFoifSwianRpIjoiNjM0MzA0ODMtZjA4ZC00NmZmLTkwMzYtYWY3OWEwNDgwOGY1In0.ZKMMS01IbPpo1BPLQCYphb93GJiMJ3f7A7W4Ho8ISaCkxhNJl9b0K_HqPFHtq4jQkPk67H6yhztXyf1mqj8RYiiCwZzhjlJlEC0fj-FPzr7DTtD0Wgm7JlgyZ6uQ5MeJGBNOqxgCnmF6KWRzeACu8e0yu_I33-N2UmxswIKGj-RCGA-Ii5OJl2huPnF7TY2ioUIxQbWbOKlaXRGQQCsIVaNzwXBg51EM4GIpr5Ej1WI5gxTUoDcBBVGyk8NzVyGbuj9QfdzZ7XjV4Yw4KSMvh_AQ837VUBLZoD5a3wrogJevJ1pgyjmNHO5JhWiun1ObFM2odVY8T9cYU33AlSxYzvBYcnxGy7uUCXqp-P21Hip1aOzYy6BreryGW8iM1jSLVxdYPkwAsq4gYPCxwo_gK0yAfVg_AlR5OMJJ0h34wmd78F1W0I4KdJ0tHQX5c-2N2RRA1q4x2FZhunh9_Nug1vii1dR_kChJZy1Mik_hjYewjm1SswcTM1NvUdV1b20zRJrMnv2Sx7HRTCct0bw9uXWiMMtGCzXfcuk3AyRDVwkqnPoRN0EDghMu7wtsC7TNTP98KgkJiLEtN9HulNFkPvgYTRltABA3phGN8vUen_sSCHUpS9LG-24aKnTw8STCvnK9GV197irPWdLLcLTI8zkA5T3vyBN1pmSSSxNnQJY"
                )
        );

        ECKey ecKey = generateECKeyAndDidKey();
        String didKey = getDidKeyFromPublicKey(ecKey.toECPublicKey());
        System.out.println("Private Key - d: " + ecKey.getD() + " x: " + ecKey.getX() + " y: " + ecKey.getY());
        // Generate a JWT to test M2M
        ECKey ecPublicJWK = ecKey.toPublicJWK();
        JWSSigner signer = new ECDSASigner(ecKey);
        Payload payload = new Payload(Map.of(
                "iss", didKey,
                "iat", 1725951134,
                "exp", 1760079134,
                "aud", "http://localhost:9000",
                "sub", didKey,
                "vp", vp,
                "jti", "6bede557-46d3-4a6a-837d-2080e4c38222"
        ));
        JWSObject jwsObject = new JWSObject(
                new JWSHeader.Builder(JWSAlgorithm.ES256).keyID(ecKey.getKeyID()).build(),
                payload);
        // Compute the EC signature
        jwsObject.sign(signer);
        // Serialize the JWS to compact form
        String jwtBearer = jwsObject.serialize();
        System.out.println("JWT: " + jwtBearer);
        // The recipient creates a verifier with the public EC key
        JWSVerifier verifier = new ECDSAVerifier(ecPublicJWK);
        // Verify the EC signature
        assertTrue("ES256 signature verified", jwsObject.verify(verifier));
        assertEquals(payload.toString(), jwsObject.getPayload().toString());

    }

    @Test
    void generateJWT2() throws NoSuchAlgorithmException, InvalidKeySpecException, JOSEException {
        Map<String, Object> vp = Map.of(
                "@context", List.of("https://www.w3.org/2018/credentials/v1"),
                "holder", "did:key:zDnaepbQkLnywX4GHsnpTuGQkBHtJ4UnGM97ts7XuM273L1ih",
                "id", "urn:uuid:41acada3-67b4-494e-a6e3-e0966449f25d",
                "type", List.of("VerifiablePresentation"),
                "verifiableCredential", List.of(
                        "eyJhbGciOiJSUzI1NiIsImN0eSI6Impzb24iLCJraWQiOiJNSUhRTUlHM3BJRzBNSUd4TVNJd0lBWURWUVFEREJsRVNVZEpWRVZNSUZSVElFRkVWa0ZPUTBWRUlFTkJJRWN5TVJJd0VBWURWUVFGRXdsQ05EYzBORGMxTmpBeEt6QXBCZ05WQkFzTUlrUkpSMGxVUlV3Z1ZGTWdRMFZTVkVsR1NVTkJWRWxQVGlCQlZWUklUMUpKVkZreEtEQW1CZ05WQkFvTUgwUkpSMGxVUlV3Z1QwNGdWRkpWVTFSRlJDQlRSVkpXU1VORlV5QlRURlV4RXpBUkJnTlZCQWNNQ2xaaGJHeGhaRzlzYVdReEN6QUpCZ05WQkFZVEFrVlRBaFJraVFqbVlLNC95SzlIbGdrVURVNHoyZEo5OWc9PSIsIng1dCNTMjU2IjoidEZHZ19WWHVBdUc3NTZpUG52aWVTWjQ2ajl6S3VINW5TdmJKMHA5cFFaUSIsIng1YyI6WyJNSUlIL1RDQ0JlV2dBd0lCQWdJVVpJa0k1bUN1UDhpdlI1WUpGQTFPTTluU2ZmWXdEUVlKS29aSWh2Y05BUUVOQlFBd2diRXhJakFnQmdOVkJBTU1HVVJKUjBsVVJVd2dWRk1nUVVSV1FVNURSVVFnUTBFZ1J6SXhFakFRQmdOVkJBVVRDVUkwTnpRME56VTJNREVyTUNrR0ExVUVDd3dpUkVsSFNWUkZUQ0JVVXlCRFJWSlVTVVpKUTBGVVNVOU9JRUZWVkVoUFVrbFVXVEVvTUNZR0ExVUVDZ3dmUkVsSFNWUkZUQ0JQVGlCVVVsVlRWRVZFSUZORlVsWkpRMFZUSUZOTVZURVRNQkVHQTFVRUJ3d0tWbUZzYkdGa2IyeHBaREVMTUFrR0ExVUVCaE1DUlZNd0hoY05NalF3TmpJeE1EWTFOelUwV2hjTk1qY3dOakl4TURZMU56VXpXakNCcXpFVk1CTUdBMVVFQXd3TVdrVlZVeUJQVEVsTlVFOVRNUmd3RmdZRFZRUUZFdzlKUkVORlZTMDVPVGs1T1RrNU9WQXhEVEFMQmdOVkJDb01CRnBGVlZNeEVEQU9CZ05WQkFRTUIwOU1TVTFRVDFNeEh6QWRCZ05WQkFzTUZrUlBUVVVnUTNKbFpHVnVkR2xoYkNCSmMzTjFaWEl4R0RBV0JnTlZCR0VNRDFaQlZFVlZMVUk1T1RrNU9UazVPVEVQTUEwR0ExVUVDZ3dHVDB4SlRWQlBNUXN3Q1FZRFZRUUdFd0pGVlRDQ0FpSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnSVBBRENDQWdvQ2dnSUJBTERkMGNGZ3A2dzdqV0dVNW9OU3hBWXVQejlodzMwWHdtQ3AxTldieTh4STBPN2I5blUwT0JwTTR1ZWRDKzdoSDd5Uk51ek9VTzF3S1IwZkpJcVkyc3picTExblZwNnNDTWl1eVlzb0d4NXJNQ3RMM3Y5TFBFdnU2MXhER0xRYVlBZnF0ZjVhTXdHL0QvOTQzdnUvTzJYZWQyc1VOYnIrZDFIYjZlUHVIRzU5ZS9YekRraTBuZUtPOHJSUllRakVlSzhDek50Z3N6NUN4cFBtZ3g5ZUVqMEYwZTEzRjErbzB5VGwzYUhET1FvVUErUWhjQzRYc2UzQkN0TXZnRTl1WTdWKzNlRUhFR2h5bUJjeldtbHVYeGpRMjJDZlREWFZvKzFEa0U3SWhkZU9pdGRBa2txT056VVRzVGwxa2gwTlByNDJaall3K1JaK3EybTI4QTYvbTVEbzBUdGlIaDFML2dHZkVaZjhBRzJUWWt6alhkSGEvdWRFY1hrTmlBeVpGZEo3RDlIYzZwZUhXdlFDZ2VES1dVakVtcExiMkx1c2pqVmRTYTdRc2hZbHZYS3I2b3FRcW5qZ0tOWTMwSXBvOTF2SUxZQ243MTJHRHlMR0x1ZEpxUXI0L0s5Y2cwR21sRUI1OGU4ZHdKRlhXK1o2c3lodW9CaEZESkRZNE9oZnFYeVQ2bnNPOEJ1WVl3YmFMQkFIZGprcmt5UUdpTFJDVk5oTDlBeHdBdXlhRkhjeU5ieXo5RDZ0ZUVXSThSWWFMN2JJNStpa0VBVkVJVWdnZlUxK1JCaFQwa3dDbmVTSk5BYUorSnN2WjA1czFNdTFhakZMWVhZMHI5clVlb1cyMkJDSmJuVXEyYjEzdS92dS9hRlZjTkpMdXE3OXp1YWZJUytybXQ2NUFqN3ZBZ01CQUFHamdnSVBNSUlDQ3pBTUJnTlZIUk1CQWY4RUFqQUFNQjhHQTFVZEl3UVlNQmFBRklJVG9hTUNsTTVpRGVBR3RqZFdRWEJjUmE0ck1IUUdDQ3NHQVFVRkJ3RUJCR2d3WmpBK0JnZ3JCZ0VGQlFjd0FvWXlhSFIwY0RvdkwzQnJhUzVrYVdkcGRHVnNkSE11WlhNdlJFbEhTVlJGVEZSVFVWVkJURWxHU1VWRVEwRkhNUzVqY25Rd0pBWUlLd1lCQlFVSE1BR0dHR2gwZEhBNkx5OXZZM053TG1ScFoybDBaV3gwY3k1bGN6Q0J3QVlEVlIwZ0JJRzRNSUcxTUlHeUJnc3JCZ0VFQVlPblVRb0RDekNCb2pBL0JnZ3JCZ0VGQlFjQ0FSWXphSFIwY0hNNkx5OXdhMmt1WkdsbmFYUmxiSFJ6TG1WekwyUndZeTlFU1VkSlZFVk1WRk5mUkZCRExuWXlMakV1Y0dSbU1GOEdDQ3NHQVFVRkJ3SUNNRk1NVVVObGNuUnBabWxqWVdSdklHTjFZV3hwWm1sallXUnZJR1JsSUdacGNtMWhJR1ZzWldOMGNtOXVhV05oSUdGMllXNTZZV1JoSUdSbElIQmxjbk52Ym1FZ1ptbHphV05oSUhacGJtTjFiR0ZrWVRBUEJna3JCZ0VGQlFjd0FRVUVBZ1VBTUIwR0ExVWRKUVFXTUJRR0NDc0dBUVVGQndNQ0JnZ3JCZ0VGQlFjREJEQkNCZ05WSFI4RU96QTVNRGVnTmFBemhqRm9kSFJ3T2k4dlkzSnNNUzV3YTJrdVpHbG5hWFJsYkhSekxtVnpMMFJVVTFGMVlXeHBabWxsWkVOQlJ6RXVZM0pzTUIwR0ExVWREZ1FXQkJSSnRva0hPWEYyMzVVSktZM0tPQVdhZ1NHZExEQU9CZ05WSFE4QkFmOEVCQU1DQnNBd0RRWUpLb1pJaHZjTkFRRU5CUUFEZ2dJQkFGME1nS1NHWXNiaURrUTVCQmZLc1VGWnpBd2xzTDhrRTYzUHlKMFBMajVzT2VUMEZMWTVJeTVmY0U2NmcwWEozSWsvUG0vYTFiK0hCd2l0bkx3ZGRKbVJwWm9ta09RSWxaYXRUQk9tQTlUd2M4OE5MdU5TdTdVM0F5cXV0akRSbFVDOFpGeWRDY1pUalF0bVVIM1FlU0d4RDYvRy82T0JGK2VVY3o1QTVkenJIMGtKNkQrYTQ3MjBjYitkZ01ycTA0OTBVbTVJcExReXRuOG5qSjNSWWtINnhVNmoxdEJpVmsrTVJ4TUZ6bUoxSlpLd1krd2pFdklidlZrVGt0eGRLWVFubFhGL1g2UlhnZjJ0MEJlK0YyRDU0R3pYcWlxeGMvRVVZM3k1Ni9rTUk1OW5ibGdia1ZPYTZHYVd3aUdPNnk1R3h2MVFlUmxVd2Z5TGZRRFR4Ykh6eXBrUysrcG55NXl2OU5kVytQR2loUVZubGFrdkFUS010M1B4WVZyYU91U3NWQVQyVVlVLy9sRGNJWU44Sk94NDB5amVubVVCci8yWE1yeDd2SzhpbkU1SzI0cmg4OXNZUVc3ZkZLM2RmQTRpeTEzblpRc1RzdWlEWVdBZWV6cTlMU3RObE9ncnFxd0RHRDdwLzRzbFh2RlhwTkxtcjlYaXVWRUtXQ0dmSXJnY0tPck5qV3hRREMwV1NsdGtNUFZTZzVrTlMwTW1GYmM0OHB3WXlmR3o2TkUvSmFVNVFzcXdBNnRtR3FLanhOUXJKRGptYXBheFltL3RYSjZhblhjY2sySWVudDRlc241UDhIdE1uK0wzQWQ0RFF4NWlkVWhPQmtsb1NWVlR2dWUvOXgrZTRQWXJDVHNiT3pBa1VtRTl3amFOSStLNW9jWmFvVEhDQTVDNyIsIk1JSUdWVENDQkQyZ0F3SUJBZ0lVRTZwM1hXYXFWOHdpZFQwR2dGZWNxOU1iSGw0d0RRWUpLb1pJaHZjTkFRRU5CUUF3Z2JFeElqQWdCZ05WQkFNTUdVUkpSMGxVUlV3Z1ZGTWdRVVJXUVU1RFJVUWdRMEVnUnpJeEVqQVFCZ05WQkFVVENVSTBOelEwTnpVMk1ERXJNQ2tHQTFVRUN3d2lSRWxIU1ZSRlRDQlVVeUJEUlZKVVNVWkpRMEZVU1U5T0lFRlZWRWhQVWtsVVdURW9NQ1lHQTFVRUNnd2ZSRWxIU1ZSRlRDQlBUaUJVVWxWVFZFVkVJRk5GVWxaSlEwVlRJRk5NVlRFVE1CRUdBMVVFQnd3S1ZtRnNiR0ZrYjJ4cFpERUxNQWtHQTFVRUJoTUNSVk13SGhjTk1qUXdOVEk1TVRJd01EUXdXaGNOTXpjd05USTJNVEl3TURNNVdqQ0JzVEVpTUNBR0ExVUVBd3daUkVsSFNWUkZUQ0JVVXlCQlJGWkJUa05GUkNCRFFTQkhNakVTTUJBR0ExVUVCUk1KUWpRM05EUTNOVFl3TVNzd0tRWURWUVFMRENKRVNVZEpWRVZNSUZSVElFTkZVbFJKUmtsRFFWUkpUMDRnUVZWVVNFOVNTVlJaTVNnd0pnWURWUVFLREI5RVNVZEpWRVZNSUU5T0lGUlNWVk5VUlVRZ1UwVlNWa2xEUlZNZ1UweFZNUk13RVFZRFZRUUhEQXBXWVd4c1lXUnZiR2xrTVFzd0NRWURWUVFHRXdKRlV6Q0NBaUl3RFFZSktvWklodmNOQVFFQkJRQURnZ0lQQURDQ0Fnb0NnZ0lCQU1PUWFCSkdVbkt2eDQwS1pENkVldVlNU3hBQWNjc0h5TkpXNnFNbms2N25PUEhCOTdnalJnbnNKeGVoVThRUGd4aE9iaHE3a1djMDJ2VzhuUUlTMnF5NzBIalcreTZJTWFPdGx5a3NvTlhPY3pRb1pDblZxQklpL2tEc09oRlYxcmNFWGFpQkVUL051SXJTS3ZHWUVJZHpBOUphcVlkZmkvSlEvbHJZYXlEZlAzZDczaHN1cStsSWpOMGQ5aCtwS2NZd0wvbUlJYksvY1F3bGxBVW1kZHJBdzlXRW1xa2wrNVJ1RFdxcGxEV2hodnBHSkZQWHQ0UnFLZ2FhVk41VFV3UzJPR0pTTnFDczZaSSthU2RuZVRnQ3FxUS8vODNoTjlRc20wbUIwTjhOTzlscVNwQ21QT2pZR09UcDdJazhpQjd0ZXgxT055ZVhNSGw5ektEY2lxVjE2MlpScEd0Sm0ycnU4NklVQ1NqUGxzcVRYTW5XMTQyTUt1Z3NXM1g3MVkwcXgzRFJVKzNMd2djSnFhTzFZLzlEMmtRRVFKM3Y1WmVpR1FhdVJXcWZqakFrRVJnaCs4bTNXWFhMcm56QW9GaHJRZGxCYTFRNjFJMlVxYnF4YkEwZFM5TGRPdDUrbkZGVlptK0U3QUFlVnlyOFVqVldUZEpRdlROM3VxMFZrTDBuMnBxMDMrSGI0Z1BSOHZycEQ3OUp5bHlVY0lSMFFOSWdNdEVGZTRlRkoraUM5K21iZU9qekhRa2w4Wkc1NTFYMkt5NnNsM09PbmY5M1hlZFFEMHZHMHJDWXBSR1orNTBrMDVqbHVLelJqY2lxQUNnTEhDRlNwY0x5QlNLZ3JYY0EwcWxwWURUSWJleDg5VHZSR1kxbm93ckM1bG1HTlQ4akpyeENZT1lEQWdNQkFBR2pZekJoTUE4R0ExVWRFd0VCL3dRRk1BTUJBZjh3SHdZRFZSMGpCQmd3Rm9BVWdoT2hvd0tVem1JTjRBYTJOMVpCY0Z4RnJpc3dIUVlEVlIwT0JCWUVGSUlUb2FNQ2xNNWlEZUFHdGpkV1FYQmNSYTRyTUE0R0ExVWREd0VCL3dRRUF3SUJoakFOQmdrcWhraUc5dzBCQVEwRkFBT0NBZ0VBSkdRS3JaMlUzSi9TcEdoUDd6V2p2d2VCWHhqVzV1U2R4MFY3bXd2NG12QzJWbEMxVHZ4RW41eVZuZEVVQ3BsR3AvbTBTM0EwN0J0UFoyNFpTdVJ3K21JcHRCbUNoYm5VMXZqMkJGcEZGVGhwc1FKRzBrRGpEMjNIbzZwM1J0TXJpYjhJaTBSbm9VYndwUDVOMkxpZU9idW9kOU9TOXEzTWdDbGh5OUY5OW1PV3ZEL3E1dkNWbyt1TFdadVE0YWN1VFROeGE1REh5aWpnQitHR28yT2hIbGRyU3BwK0xSZ1U1ZmtOS0cwTHpobElFR2RFQmFsMHB1Wi8rUXF0U3JyTERNVDRYUEtXTUo2Z3BzcjNsWGZiYTBFbDdiYi83NTZ0TVlBYlh6bW5ra1VxZGlPSTU3clZERlQ5Rkp4alZnbzVvVzhYT0tHU0xxTUgzMVhpSkNOb0g1ckpZOFZRM1ptTVN1aDk3a0FBaFh1RkliUVo3RnJrRjJ5K0dzS3BiMGE5WlVxRkJySmx6SHhDS2w4U1NUd2ZHRGdjcGVQWnhVSUlnUFBjSTRvWHdSb0IwSGJ0NTRJclJvRzdrV2s2OGdYMmNqS1YwWXRIbVZoRUVGcjNkaVpmTzdtQVRBNTRzTFpYOW4xbG9zbmY5eHJlRXpkRVlXYnlHVGhVd2wzM01QNlhMYUZSUGRiblFzaGJyb2VwemcrbmtzVTVWVksyWlpGSVdWWTZnK1JoSUNYVmRocWtCcE5tK2VLMCt3VUNBMXRYWXlSS29TVVZwTUZTQVpobnN5VWVaemFtUEhEZTRHa1RhbU1LNHFmWEtRT2I3RXRXVVdoNWZvVlN6YXF5dkZwcFU0Vk1wL2dLclBZSEQ2YldySEo1dkMvQjdXci9hUHRoTmtnWEZNR01yUjA9Il0sInR5cCI6Impvc2UiLCJzaWdUIjoiMjAyNC0wOS0xN1QxMjoyMTozMloiLCJjcml0IjpbInNpZ1QiXX0.eyJzdWIiOiJkaWQ6a2V5OnpEbmFlVjJuOW5LOFVhYnZjZ2FhOVhkSmtkYnFVYWhMTHBidDRXcVM4M0Y4cFBDdjciLCJuYmYiOjE3MjY1NzU2MDgsImlzcyI6ImRpZDplbHNpOlZBVEVTLVEwMDAwMDAwSiIsImV4cCI6MTcyOTE2NzYwOCwiaWF0IjoxNzI2NTc1NjA4LCJ2YyI6eyJAY29udGV4dCI6WyJodHRwczovL3d3dy53My5vcmcvbnMvY3JlZGVudGlhbHMvdjIiLCJodHRwczovL2RvbWUtbWFya2V0cGxhY2UuZXUvMjAyMi9jcmVkZW50aWFscy9sZWFyY3JlZGVudGlhbC92MSJdLCJpZCI6ImE5NmY0ZjA0LTI1OGYtNDM2Ny04YTIwLWQyOTk4ZTljYzc1OSIsInR5cGUiOlsiTEVBUkNyZWRlbnRpYWxFbXBsb3llZSIsIlZlcmlmaWFibGVDcmVkZW50aWFsIl0sImNyZWRlbnRpYWxTdWJqZWN0Ijp7Im1hbmRhdGUiOnsiaWQiOiJjMjk2NTA1OS1jMTkyLTRlMzYtOTU0NS02ZTY1OWViNTdhYTgiLCJsaWZlX3NwYW4iOnsiZW5kX2RhdGVfdGltZSI6IjIwMjQtMTAtMTdUMTI6MjA6MDguNDA4NTE3MDg0WiIsInN0YXJ0X2RhdGVfdGltZSI6IjIwMjQtMDktMTdUMTI6MjA6MDguNDA4NTE3MDg0WiJ9LCJtYW5kYXRlZSI6eyJpZCI6ImRpZDprZXk6ekRuYWVWMm45bks4VWFidmNnYWE5WGRKa2RicVVhaExMcGJ0NFdxUzgzRjhwUEN2NyIsImVtYWlsIjoicnViZW4ubW9kYW1pb0BpbjIuZXMiLCJmaXJzdF9uYW1lIjoiUnViZW4iLCJsYXN0X25hbWUiOiJNb2RhbWlvIEdhcmNpYSIsIm1vYmlsZV9waG9uZSI6IiszNCA2NDAwOTk5OTkifSwibWFuZGF0b3IiOnsiY29tbW9uTmFtZSI6IlpFVVMgT0xJTVBPUyIsImNvdW50cnkiOiJFUyIsImVtYWlsQWRkcmVzcyI6ImRvbWVzdXBwb3J0QGluMi5lcyIsIm9yZ2FuaXphdGlvbiI6IklOMiIsIm9yZ2FuaXphdGlvbklkZW50aWZpZXIiOiJWQVRFUy1RMDAwMDAwMEoiLCJzZXJpYWxOdW1iZXIiOiJJRENFVS05OTk5OTk5OVAifSwicG93ZXIiOlt7ImlkIjoiM2E3YmMwMDEtMGNkNi00MWNjLTk2YmQtNjUwNzQ1ZjNjMWM4IiwidG1mX2FjdGlvbiI6IkV4ZWN1dGUiLCJ0bWZfZG9tYWluIjpudWxsLCJ0bWZfZnVuY3Rpb24iOiJPbmJvYXJkaW5nIiwidG1mX3R5cGUiOiJEb21haW4ifSx7ImlkIjoiYjE4N2JmMjgtZmRhMC00OTRiLWE1YjYtNzQ5MzNjNGUwOTUwIiwidG1mX2FjdGlvbiI6WyJDcmVhdGUiLCJVcGRhdGUiXSwidG1mX2RvbWFpbiI6bnVsbCwidG1mX2Z1bmN0aW9uIjoiUHJvZHVjdE9mZmVyaW5nIiwidG1mX3R5cGUiOiJEb21haW4ifSx7ImlkIjoiY2FmNWJhNTMtMWM2My00ZjE2LTgwMjUtZjVmOWE2NjFkYjk0IiwidG1mX2FjdGlvbiI6WyJQcm92aWRlciJdLCJ0bWZfZG9tYWluIjpudWxsLCJ0bWZfZnVuY3Rpb24iOiJEb21lUGxhdGZvcm0iLCJ0bWZfdHlwZSI6IkRvbWFpbiJ9XSwic2lnbmVyIjp7ImNvbW1vbk5hbWUiOiJaRVVTIE9MSU1QT1MiLCJjb3VudHJ5IjoiRVUiLCJlbWFpbEFkZHJlc3MiOiJkb21lc3VwcG9ydEBpbjIuZXMiLCJvcmdhbml6YXRpb24iOiJPTElNUE8iLCJvcmdhbml6YXRpb25JZGVudGlmaWVyIjoiVkFURVUtQjk5OTk5OTk5Iiwic2VyaWFsTnVtYmVyIjoiSURDRVUtOTk5OTk5OTlQIn19fSwiZXhwaXJhdGlvbkRhdGUiOiIyMDI0LTEwLTE3VDEyOjIwOjA4LjQwODUxNzA4NFoiLCJpc3N1YW5jZURhdGUiOiIyMDI0LTA5LTE3VDEyOjIwOjA4LjQwODUxNzA4NFoiLCJpc3N1ZXIiOiJkaWQ6ZWxzaTpWQVRFUy1RMDAwMDAwMEoiLCJ2YWxpZEZyb20iOiIyMDI0LTA5LTE3VDEyOjIwOjA4LjQwODUxNzA4NFoifSwianRpIjoiNjM0MzA0ODMtZjA4ZC00NmZmLTkwMzYtYWY3OWEwNDgwOGY1In0.ZKMMS01IbPpo1BPLQCYphb93GJiMJ3f7A7W4Ho8ISaCkxhNJl9b0K_HqPFHtq4jQkPk67H6yhztXyf1mqj8RYiiCwZzhjlJlEC0fj-FPzr7DTtD0Wgm7JlgyZ6uQ5MeJGBNOqxgCnmF6KWRzeACu8e0yu_I33-N2UmxswIKGj-RCGA-Ii5OJl2huPnF7TY2ioUIxQbWbOKlaXRGQQCsIVaNzwXBg51EM4GIpr5Ej1WI5gxTUoDcBBVGyk8NzVyGbuj9QfdzZ7XjV4Yw4KSMvh_AQ837VUBLZoD5a3wrogJevJ1pgyjmNHO5JhWiun1ObFM2odVY8T9cYU33AlSxYzvBYcnxGy7uUCXqp-P21Hip1aOzYy6BreryGW8iM1jSLVxdYPkwAsq4gYPCxwo_gK0yAfVg_AlR5OMJJ0h34wmd78F1W0I4KdJ0tHQX5c-2N2RRA1q4x2FZhunh9_Nug1vii1dR_kChJZy1Mik_hjYewjm1SswcTM1NvUdV1b20zRJrMnv2Sx7HRTCct0bw9uXWiMMtGCzXfcuk3AyRDVwkqnPoRN0EDghMu7wtsC7TNTP98KgkJiLEtN9HulNFkPvgYTRltABA3phGN8vUen_sSCHUpS9LG-24aKnTw8STCvnK9GV197irPWdLLcLTI8zkA5T3vyBN1pmSSSxNnQJY"
                )
        );

        ECKey ecKey = generateECKeyAndDidKey();
        String didKey = getDidKeyFromPublicKey(ecKey.toECPublicKey());
        System.out.println("Private Key - d: " + ecKey.getD() + " x: " + ecKey.getX() + " y: " + ecKey.getY());
        // Generate a JWT to test M2M
        ECKey ecPublicJWK = ecKey.toPublicJWK();
        JWSSigner signer = new ECDSASigner(ecKey);
        Payload payload = new Payload(Map.of(
                "iss", didKey,
                "iat", 1725951134,
                "exp", 1760079134,
                "aud", "http://localhost:9000",
                "sub", didKey,
                "vp", vp,
                "jti", "6bede557-46d3-4a6a-837d-2080e4c38222"
        ));
        JWSObject jwsObject = new JWSObject(
                new JWSHeader.Builder(JWSAlgorithm.ES256)
                        .type(JOSEObjectType.JWT)
                        .keyID(ecKey.getKeyID() + "#" + ecKey.getKeyID().replace("did:key:","")).build(),
                payload);
        // Compute the EC signature
        jwsObject.sign(signer);
        // Serialize the JWS to compact form
        String jwtBearer = jwsObject.serialize();
        System.out.println("JWT: " + jwtBearer);
        // The recipient creates a verifier with the public EC key
        JWSVerifier verifier = new ECDSAVerifier(ecPublicJWK);
        // Verify the EC signature
        assertTrue("ES256 signature verified", jwsObject.verify(verifier));
        assertEquals(payload.toString(), jwsObject.getPayload().toString());

    }

    private ECKey generateECKeyAndDidKey() throws NoSuchAlgorithmException, InvalidKeySpecException {
        // Generate a new key pair
        KeyPairGenerator keyPairGenerator = KeyPairGenerator.getInstance("EC");
        keyPairGenerator.initialize(256);
        KeyPair keyPair = keyPairGenerator.generateKeyPair();
        // Get Private and Public Key
        ECPublicKey publicKey = (ECPublicKey) keyPair.getPublic();
        ECPrivateKey privateKey = (ECPrivateKey) keyPair.getPrivate();
        // Build did:key from KeyPair
        byte[] encodedKey = publicKey.getEncoded();
        KeyFactory keyFactory = KeyFactory.getInstance("EC", BouncyCastleProviderSingleton.getInstance());
        X509EncodedKeySpec keySpec = new X509EncodedKeySpec(encodedKey);
        BCECPublicKey bcPublicKey = (BCECPublicKey) keyFactory.generatePublic(keySpec);
        byte[] pubKeyBytes = bcPublicKey.getQ().getEncoded(true);
        int multiCodecKeyCodeForSecp256r1 = 0x1200;
        UVarInt codeVarInt = new UVarInt(multiCodecKeyCodeForSecp256r1);
        int totalLength = pubKeyBytes.length + codeVarInt.getLength();
        byte[] multicodecAndRawKey = new byte[totalLength];
        System.arraycopy(codeVarInt.getBytes(), 0, multicodecAndRawKey, 0, codeVarInt.getLength());
        System.arraycopy(pubKeyBytes, 0, multicodecAndRawKey, codeVarInt.getLength(), pubKeyBytes.length);
        String multiBase58Btc = Base58.encode(multicodecAndRawKey);
        String didKey = "did:key:z" + multiBase58Btc;
        System.out.println("DID Key: " + didKey);
        return new ECKey.Builder(Curve.P_256, publicKey)
                .privateKey(privateKey)
                .keyID(didKey)
                .build();
    }

    private String getDidKeyFromPublicKey(ECPublicKey publicKey) throws NoSuchAlgorithmException, InvalidKeySpecException {
        byte[] encodedKey = publicKey.getEncoded();
        KeyFactory keyFactory = KeyFactory.getInstance("EC", BouncyCastleProviderSingleton.getInstance());
        X509EncodedKeySpec keySpec = new X509EncodedKeySpec(encodedKey);
        BCECPublicKey bcPublicKey = (BCECPublicKey) keyFactory.generatePublic(keySpec);
        byte[] pubKeyBytes = bcPublicKey.getQ().getEncoded(true);
        int multiCodecKeyCodeForSecp256r1 = 0x1200;
        UVarInt codeVarInt = new UVarInt(multiCodecKeyCodeForSecp256r1);
        int totalLength = pubKeyBytes.length + codeVarInt.getLength();
        byte[] multicodecAndRawKey = new byte[totalLength];
        System.arraycopy(codeVarInt.getBytes(), 0, multicodecAndRawKey, 0, codeVarInt.getLength());
        System.arraycopy(pubKeyBytes, 0, multicodecAndRawKey, codeVarInt.getLength(), pubKeyBytes.length);
        String multiBase58Btc = Base58.encode(multicodecAndRawKey);
        return "did:key:z" + multiBase58Btc;
    }

    @Test
    void verifyJWTSignature() {
        String jwt = """
eyJraWQiOiJkaWQ6a2V5OnpEbmFlVjJuOW5LOFVhYnZjZ2FhOVhkSmtkYnFVYWhMTHBidDRXcVM4M0Y4cFBDdjcjekRuYWVWMm45bks4VWFidmNnYWE5WGRKa2RicVVhaExMcGJ0NFdxUzgzRjhwUEN2NyIsInR5cCI6IkpXVCIsImFsZyI6IkVTMjU2In0.eyJzdWIiOiJkaWQ6a2V5OnpEbmFlVjJuOW5LOFVhYnZjZ2FhOVhkSmtkYnFVYWhMTHBidDRXcVM4M0Y4cFBDdjciLCJuYmYiOjE3MjY2NDU5MTcsImlzcyI6ImRpZDprZXk6ekRuYWVWMm45bks4VWFidmNnYWE5WGRKa2RicVVhaExMcGJ0NFdxUzgzRjhwUEN2NyIsInZwIjp7IkBjb250ZXh0IjpbImh0dHBzOi8vd3d3LnczLm9yZy8yMDE4L2NyZWRlbnRpYWxzL3YxIl0sImhvbGRlciI6ImRpZDprZXk6ekRuYWVWMm45bks4VWFidmNnYWE5WGRKa2RicVVhaExMcGJ0NFdxUzgzRjhwUEN2NyIsImlkIjoidXJuOnV1aWQ6Y2NhMjlkYTUtNWQzZi00MzMwLWI0NGEtMWIyMGZjMWU4OTk3IiwidHlwZSI6WyJWZXJpZmlhYmxlUHJlc2VudGF0aW9uIl0sInZlcmlmaWFibGVDcmVkZW50aWFsIjpbImV5SmhiR2NpT2lKU1V6STFOaUlzSW1OMGVTSTZJbXB6YjI0aUxDSnJhV1FpT2lKTlNVaFJUVWxITTNCSlJ6Qk5TVWQ0VFZOSmQwbEJXVVJXVVZGRVJFSnNSVk5WWkVwV1JWWk5TVVpTVkVsRlJrVldhMFpQVVRCV1JVbEZUa0pKUldONVRWSkpkMFZCV1VSV1VWRkdSWGRzUTA1RVl6Qk9SR014VG1wQmVFdDZRWEJDWjA1V1FrRnpUVWxyVWtwU01HeFZVbFYzWjFaR1RXZFJNRlpUVmtWc1IxTlZUa0pXUld4UVZHbENRbFpXVWtsVU1VcEtWa1pyZUV0RVFXMUNaMDVXUWtGdlRVZ3dVa3BTTUd4VlVsVjNaMVF3TkdkV1JrcFdWVEZTUmxKRFFsUlNWa3BYVTFWT1JsVjVRbFJVUmxWNFJYcEJVa0puVGxaQ1FXTk5RMnhhYUdKSGVHaGFSemx6WVZkUmVFTjZRVXBDWjA1V1FrRlpWRUZyVmxSQmFGSnJhVkZxYlZsTE5DOTVTemxJYkdkclZVUlZOSG95WkVvNU9XYzlQU0lzSW5nMWRDTlRNalUySWpvaWRFWkhaMTlXV0hWQmRVYzNOVFpwVUc1MmFXVlRXalEyYWpsNlMzVklOVzVUZG1KS01IQTVjRkZhVVNJc0luZzFZeUk2V3lKTlNVbElMMVJEUTBKbFYyZEJkMGxDUVdkSlZWcEphMGsxYlVOMVVEaHBkbEkxV1VwR1FURlBUVGx1VTJabVdYZEVVVmxLUzI5YVNXaDJZMDVCVVVWT1FsRkJkMmRpUlhoSmFrRm5RbWRPVmtKQlRVMUhWVkpLVWpCc1ZWSlZkMmRXUmsxblVWVlNWMUZWTlVSU1ZWRm5VVEJGWjFKNlNYaEZha0ZSUW1kT1ZrSkJWVlJEVlVrd1RucFJNRTU2VlRKTlJFVnlUVU5yUjBFeFZVVkRkM2RwVWtWc1NGTldVa1pVUTBKVlZYbENSRkpXU2xWVFZWcEtVVEJHVlZOVk9VOUpSVVpXVmtWb1VGVnJiRlZYVkVWdlRVTlpSMEV4VlVWRFozZG1Va1ZzU0ZOV1VrWlVRMEpRVkdsQ1ZWVnNWbFJXUlZaRlNVWk9SbFZzV2twUk1GWlVTVVpPVFZaVVJWUk5Ra1ZIUVRGVlJVSjNkMHRXYlVaellrZEdhMkl5ZUhCYVJFVk1UVUZyUjBFeFZVVkNhRTFEVWxaTmQwaG9ZMDVOYWxGM1RtcEplRTFFV1RGT2VsVXdWMmhqVGsxcVkzZE9ha2w0VFVSWk1VNTZWWHBYYWtOQ2NYcEZWazFDVFVkQk1WVkZRWGQzVFZkclZsWlZlVUpRVkVWc1RsVkZPVlJOVW1kM1JtZFpSRlpSVVVaRmR6bEtVa1ZPUmxaVE1EVlBWR3MxVDFSck5VOVdRWGhFVkVGTVFtZE9Wa0pEYjAxQ1JuQkdWbFpOZUVWRVFVOUNaMDVXUWtGUlRVSXdPVTFUVlRGUlZERk5lRWg2UVdSQ1owNVdRa0Z6VFVaclVsQlVWVlZuVVROS2JGcEhWblZrUjJ4b1lrTkNTbU16VGpGYVdFbDRSMFJCVjBKblRsWkNSMFZOUkRGYVFsWkZWbFpNVlVrMVQxUnJOVTlVYXpWUFZFVlFUVUV3UjBFeFZVVkRaM2RIVkRCNFNsUldRbEJOVVhOM1ExRlpSRlpSVVVkRmQwcEdWbFJEUTBGcFNYZEVVVmxLUzI5YVNXaDJZMDVCVVVWQ1FsRkJSR2RuU1ZCQlJFTkRRV2R2UTJkblNVSkJURVJrTUdOR1ozQTJkemRxVjBkVk5XOU9VM2hCV1hWUWVqbG9kek13V0hkdFEzQXhUbGRpZVRoNFNUQlBOMkk1YmxVd1QwSndUVFIxWldSREt6ZG9TRGQ1VWs1MWVrOVZUekYzUzFJd1prcEpjVmt5YzNwaWNURXhibFp3Tm5ORFRXbDFlVmx6YjBkNE5YSk5RM1JNTTNZNVRGQkZkblUyTVhoRVIweFJZVmxCWm5GMFpqVmhUWGRITDBRdk9UUXpkblV2VHpKWVpXUXljMVZPWW5JclpERklZalpsVUhWSVJ6VTVaUzlZZWtScmFUQnVaVXRQT0hKU1VsbFJha1ZsU3poRGVrNTBaM042TlVONGNGQnRaM2c1WlVWcU1FWXdaVEV6UmpFcmJ6QjVWR3d6WVVoRVQxRnZWVUVyVVdoalF6UlljMlV6UWtOMFRYWm5SVGwxV1RkV0t6TmxSVWhGUjJoNWJVSmplbGR0YkhWWWVHcFJNakpEWmxSRVdGWnZLekZFYTBVM1NXaGtaVTlwZEdSQmEydHhUMDU2VlZSelZHd3hhMmd3VGxCeU5ESmFhbGwzSzFKYUszRXliVEk0UVRZdmJUVkViekJVZEdsSWFERk1MMmRIWmtWYVpqaEJSekpVV1d0NmFsaGtTR0V2ZFdSRlkxaHJUbWxCZVZwR1pFbzNSRGxJWXpad1pVaFhkbEZEWjJWRVMxZFZha1Z0Y0V4aU1reDFjMnBxVm1SVFlUZFJjMmhaYkhaWVMzSTJiM0ZSY1c1cVowdE9XVE13U1hCdk9URjJTVXhaUTI0M01USkhSSGxNUjB4MVpFcHhVWEkwTDBzNVkyY3dSMjFzUlVJMU9HVTRaSGRLUmxoWEsxbzJjM2xvZFc5Q2FFWkVTa1JaTkU5b1puRlllVlEyYm5OUE9FSjFXVmwzWW1GTVFrRklaR3ByY210NVVVZHBURkpEVms1b1REbEJlSGRCZFhsaFJraGplVTVpZVhvNVJEWjBaVVZYU1RoU1dXRk1OMkpKTlN0cGEwVkJWa1ZKVldkblpsVXhLMUpDYUZRd2EzZERibVZUU2s1QllVb3JTbk4yV2pBMWN6Rk5kVEZoYWtaTVdWaFpNSEk1Y2xWbGIxY3lNa0pEU21KdVZYRXlZakV6ZFM5MmRTOWhSbFpqVGtwTWRYRTNPWHAxWVdaSlV5dHliWFEyTlVGcU4zWkJaMDFDUVVGSGFtZG5TVkJOU1VsRFEzcEJUVUpuVGxaSVVrMUNRV1k0UlVGcVFVRk5RamhIUVRGVlpFbDNVVmxOUW1GQlJrbEpWRzloVFVOc1RUVnBSR1ZCUjNScVpGZFJXRUpqVW1FMGNrMUlVVWREUTNOSFFWRlZSa0ozUlVKQ1IyZDNXbXBCSzBKblozSkNaMFZHUWxGamQwRnZXWGxoU0ZJd1kwUnZka3d6UW5KaFV6VnJZVmRrY0dSSFZuTmtTRTExV2xoTmRsSkZiRWhUVmxKR1ZFWlNWRlZXVmtKVVJXeEhVMVZXUlZFd1JraE5VelZxWTI1UmQwcEJXVWxMZDFsQ1FsRlZTRTFCUjBkSFIyZ3daRWhCTmt4NU9YWlpNMDUzVEcxU2NGb3liREJhVjNnd1kzazFiR042UTBKM1FWbEVWbEl3WjBKSlJ6Uk5TVWN4VFVsSGVVSm5jM0pDWjBWRlFWbFBibFZSYjBSRGVrTkNiMnBCTDBKblozSkNaMFZHUWxGalEwRlNXWHBoU0ZJd1kwaE5Oa3g1T1hkaE1tdDFXa2RzYm1GWVVteGlTRko2VEcxV2Vrd3lVbmRaZVRsRlUxVmtTbFpGVmsxV1JrNW1Va1pDUkV4dVdYbE1ha1YxWTBkU2JVMUdPRWREUTNOSFFWRlZSa0ozU1VOTlJrMU5WVlZPYkdOdVVuQmFiV3hxV1ZkU2RrbEhUakZaVjNod1dtMXNhbGxYVW5aSlIxSnNTVWRhY0dOdE1XaEpSMVp6V2xkT01HTnRPWFZoVjA1b1NVZEdNbGxYTlRaWlYxSm9TVWRTYkVsSVFteGpiazUyWW0xRloxcHRiSHBoVjA1b1NVaGFjR0p0VGpGaVIwWnJXVlJCVUVKbmEzSkNaMFZHUWxGamQwRlJWVVZCWjFWQlRVSXdSMEV4VldSS1VWRlhUVUpSUjBORGMwZEJVVlZHUW5kTlEwSm5aM0pDWjBWR1FsRmpSRUpFUWtOQ1owNVdTRkk0UlU5NlFUVk5SR1ZuVG1GQmVtaHFSbTlrU0ZKM1QyazRkbGt6U25OTlV6VjNZVEpyZFZwSGJHNWhXRkpzWWtoU2VreHRWbnBNTUZKVlZURkdNVmxYZUhCYWJXeHNXa1ZPUWxKNlJYVlpNMHB6VFVJd1IwRXhWV1JFWjFGWFFrSlNTblJ2YTBoUFdFWXlNelZWU2t0Wk0wdFBRVmRoWjFOSFpFeEVRVTlDWjA1V1NGRTRRa0ZtT0VWQ1FVMURRbk5CZDBSUldVcExiMXBKYUhaalRrRlJSVTVDVVVGRVoyZEpRa0ZHTUUxblMxTkhXWE5pYVVSclVUVkNRbVpMYzFWR1ducEJkMnh6VERoclJUWXpVSGxLTUZCTWFqVnpUMlZVTUVaTVdUVkplVFZtWTBVMk5tY3dXRW96U1dzdlVHMHZZVEZpSzBoQ2QybDBia3gzWkdSS2JWSndXbTl0YTA5UlNXeGFZWFJVUWs5dFFUbFVkMk00T0U1TWRVNVRkVGRWTTBGNWNYVjBha1JTYkZWRE9GcEdlV1JEWTFwVWFsRjBiVlZJTTFGbFUwZDRSRFl2Unk4MlQwSkdLMlZWWTNvMVFUVmtlbkpJTUd0S05rUXJZVFEzTWpCallpdGtaMDF5Y1RBME9UQlZiVFZKY0V4UmVYUnVPRzVxU2pOU1dXdElObmhWTm1veGRFSnBWbXNyVFZKNFRVWjZiVW94U2xwTGQxa3JkMnBGZGtsaWRsWnJWR3QwZUdSTFdWRnViRmhHTDFnMlVsaG5aakowTUVKbEswWXlSRFUwUjNwWWNXbHhlR012UlZWWk0zazFOaTlyVFVrMU9XNWliR2RpYTFaUFlUWkhZVmQzYVVkUE5uazFSM2gyTVZGbFVteFZkMlo1VEdaUlJGUjRZa2g2ZVhCclV5c3JjRzU1TlhsMk9VNWtWeXRRUjJsb1VWWnViR0ZyZGtGVVMwMTBNMUI0V1ZaeVlVOTFVM05XUVZReVZWbFZMeTlzUkdOSldVNDRTazk0TkRCNWFtVnViVlZDY2k4eVdFMXllRGQyU3pocGJrVTFTekkwY21nNE9YTlpVVmMzWmtaTE0yUm1RVFJwZVRFemJscFJjMVJ6ZFdsRVdWZEJaV1Y2Y1RsTVUzUk9iRTluY25GeGQwUkhSRGR3THpSemJGaDJSbGh3VGt4dGNqbFlhWFZXUlV0WFEwZG1TWEpuWTB0UGNrNXFWM2hSUkVNd1YxTnNkR3ROVUZaVFp6VnJUbE13VFcxR1ltTTBPSEIzV1hsbVIzbzJUa1V2U21GVk5WRnpjWGRCTm5SdFIzRkxhbmhPVVhKS1JHcHRZWEJoZUZsdEwzUllTalpoYmxoalkyc3lTV1Z1ZERSbGMyNDFVRGhJZEUxdUswd3pRV1EwUkZGNE5XbGtWV2hQUW10c2IxTldWbFIyZFdVdk9YZ3JaVFJRV1hKRFZITmlUM3BCYTFWdFJUbDNhbUZPU1N0TE5XOWpXbUZ2VkVoRFFUVkROeUlzSWsxSlNVZFdWRU5EUWtReVowRjNTVUpCWjBsVlJUWndNMWhYWVhGV09IZHBaRlF3UjJkR1pXTnhPVTFpU0d3MGQwUlJXVXBMYjFwSmFIWmpUa0ZSUlU1Q1VVRjNaMkpGZUVscVFXZENaMDVXUWtGTlRVZFZVa3BTTUd4VlVsVjNaMVpHVFdkUlZWSlhVVlUxUkZKVlVXZFJNRVZuVW5wSmVFVnFRVkZDWjA1V1FrRlZWRU5WU1RCT2VsRXdUbnBWTWsxRVJYSk5RMnRIUVRGVlJVTjNkMmxTUld4SVUxWlNSbFJEUWxWVmVVSkVVbFpLVlZOVldrcFJNRVpWVTFVNVQwbEZSbFpXUldoUVZXdHNWVmRVUlc5TlExbEhRVEZWUlVObmQyWlNSV3hJVTFaU1JsUkRRbEJVYVVKVlZXeFdWRlpGVmtWSlJrNUdWV3hhU2xFd1ZsUkpSazVOVmxSRlZFMUNSVWRCTVZWRlFuZDNTMVp0Um5OaVIwWnJZako0Y0ZwRVJVeE5RV3RIUVRGVlJVSm9UVU5TVmsxM1NHaGpUazFxVVhkT1ZFazFUVlJKZDAxRVVYZFhhR05PVFhwamQwNVVTVEpOVkVsM1RVUk5OVmRxUTBKelZFVnBUVU5CUjBFeFZVVkJkM2RhVWtWc1NGTldVa1pVUTBKVlZYbENRbEpHV2tKVWEwNUdVa05DUkZGVFFraE5ha1ZUVFVKQlIwRXhWVVZDVWsxS1VXcFJNMDVFVVROT1ZGbDNUVk56ZDB0UldVUldVVkZNUkVOS1JWTlZaRXBXUlZaTlNVWlNWRWxGVGtaVmJGSktVbXRzUkZGV1VrcFVNRFJuVVZaV1ZWTkZPVk5UVmxKYVRWTm5kMHBuV1VSV1VWRkxSRUk1UlZOVlpFcFdSVlpOU1VVNVQwbEdVbE5XVms1VlVsVlJaMVV3VmxOV2EyeEVVbFpOWjFVd2VGWk5VazEzUlZGWlJGWlJVVWhFUVhCWFdWZDRjMWxYVW5aaVIyeHJUVkZ6ZDBOUldVUldVVkZIUlhkS1JsVjZRME5CYVVsM1JGRlpTa3R2V2tsb2RtTk9RVkZGUWtKUlFVUm5aMGxRUVVSRFEwRm5iME5uWjBsQ1FVMVBVV0ZDU2tkVmJrdDJlRFF3UzFwRU5rVmxkVmxOVTNoQlFXTmpjMGg1VGtwWE5uRk5ibXMyTjI1UFVFaENPVGRuYWxKbmJuTktlR1ZvVlRoUlVHZDRhRTlpYUhFM2ExZGpNREoyVnpodVVVbFRNbkY1TnpCSWFsY3JlVFpKVFdGUGRHeDVhM052VGxoUFkzcFJiMXBEYmxaeFFrbHBMMnRFYzA5b1JsWXhjbU5GV0dGcFFrVlVMMDUxU1hKVFMzWkhXVVZKWkhwQk9VcGhjVmxrWm1rdlNsRXZiSEpaWVhsRVpsQXpaRGN6YUhOMWNTdHNTV3BPTUdRNWFDdHdTMk5aZDB3dmJVbEpZa3N2WTFGM2JHeEJWVzFrWkhKQmR6bFhSVzF4YTJ3ck5WSjFSRmR4Y0d4RVYyaG9kbkJIU2taUVdIUTBVbkZMWjJGaFZrNDFWRlYzVXpKUFIwcFRUbkZEY3paYVNTdGhVMlJ1WlZSblEzRnhVUzh2T0ROb1RqbFJjMjB3YlVJd1RqaE9UemxzY1ZOd1EyMVFUMnBaUjA5VWNEZEphemhwUWpkMFpYZ3hUMDU1WlZoTlNHdzVla3RFWTJseFZqRTJNbHBTY0VkMFNtMHljblU0TmtsVlExTnFVR3h6Y1ZSWVRXNVhNVFF5VFV0MVozTlhNMWczTVZrd2NYZ3pSRkpWS3pOTWQyZGpTbkZoVHpGWkx6bEVNbXRSUlZGS00zWTFXbVZwUjFGaGRWSlhjV1pxYWtGclJWSm5hQ3M0YlROWFdGaE1jbTU2UVc5R2FISlJaR3hDWVRGUk5qRkpNbFZ4WW5GNFlrRXdaRk01VEdSUGREVXJia1pHVmxwdEswVTNRVUZsVm5seU9GVnFWbGRVWkVwUmRsUk9NM1Z4TUZaclREQnVNbkJ4TURNclNHSTBaMUJTT0haeWNFUTNPVXA1YkhsVlkwbFNNRkZPU1dkTmRFVkdaVFJsUmtvcmFVTTVLMjFpWlU5cWVraFJhMnc0V2tjMU5URllNa3Q1Tm5Oc00wOVBibVk1TTFobFpGRkVNSFpITUhKRFdYQlNSMW9yTlRCck1EVnFiSFZMZWxKcVkybHhRVU5uVEVoRFJsTndZMHg1UWxOTFozSllZMEV3Y1d4d1dVUlVTV0psZURnNVZIWlNSMWt4Ym05M2NrTTFiRzFIVGxRNGFrcHllRU5aVDFsRVFXZE5Ra0ZCUjJwWmVrSm9UVUU0UjBFeFZXUkZkMFZDTDNkUlJrMUJUVUpCWmpoM1NIZFpSRlpTTUdwQ1FtZDNSbTlCVldkb1QyaHZkMHRWZW0xSlRqUkJZVEpPTVZwQ1kwWjRSbkpwYzNkSVVWbEVWbEl3VDBKQ1dVVkdTVWxVYjJGTlEyeE5OV2xFWlVGSGRHcGtWMUZZUW1OU1lUUnlUVUUwUjBFeFZXUkVkMFZDTDNkUlJVRjNTVUpvYWtGT1FtZHJjV2hyYVVjNWR6QkNRVkV3UmtGQlQwTkJaMFZCU2tkUlMzSmFNbFV6U2k5VGNFZG9VRGQ2VjJwMmQyVkNXSGhxVnpWMVUyUjRNRlkzYlhkMk5HMTJRekpXYkVNeFZIWjRSVzQxZVZadVpFVlZRM0JzUjNBdmJUQlRNMEV3TjBKMFVGb3lORnBUZFZKM0syMUpjSFJDYlVOb1ltNVZNWFpxTWtKR2NFWkdWR2h3YzFGS1J6QnJSR3BFTWpOSWJ6WndNMUowVFhKcFlqaEphVEJTYm05VlluZHdVRFZPTWt4cFpVOWlkVzlrT1U5VE9YRXpUV2REYkdoNU9VWTVPVzFQVjNaRUwzRTFka05XYnl0MVRGZGFkVkUwWVdOMVZGUk9lR0UxUkVoNWFXcG5RaXRIUjI4eVQyaEliR1J5VTNCd0sweFNaMVUxWm10T1MwY3dUSHBvYkVsRlIyUkZRbUZzTUhCMVdpOHJVWEYwVTNKeVRFUk5WRFJZVUV0WFRVbzJaM0J6Y2pOc1dHWmlZVEJGYkRkaVlpODNOVFowVFZsQllsaDZiVzVyYTFWeFpHbFBTVFUzY2xaRVJsUTVSa3A0YWxabmJ6VnZWemhZVDB0SFUweHhUVWd6TVZocFNrTk9iMGcxY2twWk9GWlJNMXB0VFZOMWFEazNhMEZCYUZoMVJrbGlVVm8zUm5KclJqSjVLMGR6UzNCaU1HRTVXbFZ4UmtKeVNteDZTSGhEUzJ3NFUxTlVkMlpIUkdkamNHVlFXbmhWU1VsblVGQmpTVFJ2V0hkU2IwSXdTR0owTlRSSmNsSnZSemRyVjJzMk9HZFlNbU5xUzFZd1dYUkliVlpvUlVWR2NqTmthVnBtVHpkdFFWUkJOVFJ6VEZwWU9XNHhiRzl6Ym1ZNWVISmxSWHBrUlZsWFlubEhWR2hWZDJ3ek0wMVFObGhNWVVaU1VHUmlibEZ6YUdKeWIyVndlbWNyYm10elZUVldWa3N5V2xwR1NWZFdXVFpuSzFKb1NVTllWbVJvY1d0Q2NFNXRLMlZMTUN0M1ZVTkJNWFJZV1hsU1MyOVRWVlp3VFVaVFFWcG9ibk41VldWYWVtRnRVRWhFWlRSSGExUmhiVTFMTkhGbVdFdFJUMkkzUlhSWFZWZG9OV1p2VmxONllYRjVka1p3Y0ZVMFZrMXdMMmRMY2xCWlNFUTJZbGR5U0VvMWRrTXZRamRYY2k5aFVIUm9UbXRuV0VaTlIwMXlVakE5SWwwc0luUjVjQ0k2SW1wdmMyVWlMQ0p6YVdkVUlqb2lNakF5TkMwd09TMHhOMVF4TWpveU1Ub3pNbG9pTENKamNtbDBJanBiSW5OcFoxUWlYWDAuZXlKemRXSWlPaUprYVdRNmEyVjVPbnBFYm1GbFZqSnVPVzVMT0ZWaFluWmpaMkZoT1Zoa1NtdGtZbkZWWVdoTVRIQmlkRFJYY1ZNNE0wWTRjRkJEZGpjaUxDSnVZbVlpT2pFM01qWTFOelUyTURnc0ltbHpjeUk2SW1ScFpEcGxiSE5wT2xaQlZFVlRMVkV3TURBd01EQXdTaUlzSW1WNGNDSTZNVGN5T1RFMk56WXdPQ3dpYVdGMElqb3hOekkyTlRjMU5qQTRMQ0oyWXlJNmV5SkFZMjl1ZEdWNGRDSTZXeUpvZEhSd2N6b3ZMM2QzZHk1M015NXZjbWN2Ym5NdlkzSmxaR1Z1ZEdsaGJITXZkaklpTENKb2RIUndjem92TDJSdmJXVXRiV0Z5YTJWMGNHeGhZMlV1WlhVdk1qQXlNaTlqY21Wa1pXNTBhV0ZzY3k5c1pXRnlZM0psWkdWdWRHbGhiQzkyTVNKZExDSnBaQ0k2SW1FNU5tWTBaakEwTFRJMU9HWXRORE0yTnkwNFlUSXdMV1F5T1RrNFpUbGpZemMxT1NJc0luUjVjR1VpT2xzaVRFVkJVa055WldSbGJuUnBZV3hGYlhCc2IzbGxaU0lzSWxabGNtbG1hV0ZpYkdWRGNtVmtaVzUwYVdGc0lsMHNJbU55WldSbGJuUnBZV3hUZFdKcVpXTjBJanA3SW0xaGJtUmhkR1VpT25zaWFXUWlPaUpqTWprMk5UQTFPUzFqTVRreUxUUmxNell0T1RVME5TMDJaVFkxT1dWaU5UZGhZVGdpTENKc2FXWmxYM053WVc0aU9uc2laVzVrWDJSaGRHVmZkR2x0WlNJNklqSXdNalF0TVRBdE1UZFVNVEk2TWpBNk1EZ3VOREE0TlRFM01EZzBXaUlzSW5OMFlYSjBYMlJoZEdWZmRHbHRaU0k2SWpJd01qUXRNRGt0TVRkVU1USTZNakE2TURndU5EQTROVEUzTURnMFdpSjlMQ0p0WVc1a1lYUmxaU0k2ZXlKcFpDSTZJbVJwWkRwclpYazZla1J1WVdWV01tNDVia3M0VldGaWRtTm5ZV0U1V0dSS2EyUmljVlZoYUV4TWNHSjBORmR4VXpnelJqaHdVRU4yTnlJc0ltVnRZV2xzSWpvaWNuVmlaVzR1Ylc5a1lXMXBiMEJwYmpJdVpYTWlMQ0ptYVhKemRGOXVZVzFsSWpvaVVuVmlaVzRpTENKc1lYTjBYMjVoYldVaU9pSk5iMlJoYldsdklFZGhjbU5wWVNJc0ltMXZZbWxzWlY5d2FHOXVaU0k2SWlzek5DQTJOREF3T1RrNU9Ua2lmU3dpYldGdVpHRjBiM0lpT25zaVkyOXRiVzl1VG1GdFpTSTZJbHBGVlZNZ1QweEpUVkJQVXlJc0ltTnZkVzUwY25raU9pSkZVeUlzSW1WdFlXbHNRV1JrY21WemN5STZJbVJ2YldWemRYQndiM0owUUdsdU1pNWxjeUlzSW05eVoyRnVhWHBoZEdsdmJpSTZJa2xPTWlJc0ltOXlaMkZ1YVhwaGRHbHZia2xrWlc1MGFXWnBaWElpT2lKV1FWUkZVeTFSTURBd01EQXdNRW9pTENKelpYSnBZV3hPZFcxaVpYSWlPaUpKUkVORlZTMDVPVGs1T1RrNU9WQWlmU3dpY0c5M1pYSWlPbHQ3SW1sa0lqb2lNMkUzWW1Nd01ERXRNR05rTmkwME1XTmpMVGsyWW1RdE5qVXdOelExWmpOak1XTTRJaXdpZEcxbVgyRmpkR2x2YmlJNklrVjRaV04xZEdVaUxDSjBiV1pmWkc5dFlXbHVJanB1ZFd4c0xDSjBiV1pmWm5WdVkzUnBiMjRpT2lKUGJtSnZZWEprYVc1bklpd2lkRzFtWDNSNWNHVWlPaUpFYjIxaGFXNGlmU3g3SW1sa0lqb2lZakU0TjJKbU1qZ3RabVJoTUMwME9UUmlMV0UxWWpZdE56UTVNek5qTkdVd09UVXdJaXdpZEcxbVgyRmpkR2x2YmlJNld5SkRjbVZoZEdVaUxDSlZjR1JoZEdVaVhTd2lkRzFtWDJSdmJXRnBiaUk2Ym5Wc2JDd2lkRzFtWDJaMWJtTjBhVzl1SWpvaVVISnZaSFZqZEU5bVptVnlhVzVuSWl3aWRHMW1YM1I1Y0dVaU9pSkViMjFoYVc0aWZTeDdJbWxrSWpvaVkyRm1OV0poTlRNdE1XTTJNeTAwWmpFMkxUZ3dNalV0WmpWbU9XRTJOakZrWWprMElpd2lkRzFtWDJGamRHbHZiaUk2V3lKUWNtOTJhV1JsY2lKZExDSjBiV1pmWkc5dFlXbHVJanB1ZFd4c0xDSjBiV1pmWm5WdVkzUnBiMjRpT2lKRWIyMWxVR3hoZEdadmNtMGlMQ0owYldaZmRIbHdaU0k2SWtSdmJXRnBiaUo5WFN3aWMybG5ibVZ5SWpwN0ltTnZiVzF2Yms1aGJXVWlPaUphUlZWVElFOU1TVTFRVDFNaUxDSmpiM1Z1ZEhKNUlqb2lSVlVpTENKbGJXRnBiRUZrWkhKbGMzTWlPaUprYjIxbGMzVndjRzl5ZEVCcGJqSXVaWE1pTENKdmNtZGhibWw2WVhScGIyNGlPaUpQVEVsTlVFOGlMQ0p2Y21kaGJtbDZZWFJwYjI1SlpHVnVkR2xtYVdWeUlqb2lWa0ZVUlZVdFFqazVPVGs1T1RrNUlpd2ljMlZ5YVdGc1RuVnRZbVZ5SWpvaVNVUkRSVlV0T1RrNU9UazVPVGxRSW4xOWZTd2laWGh3YVhKaGRHbHZia1JoZEdVaU9pSXlNREkwTFRFd0xURTNWREV5T2pJd09qQTRMalF3T0RVeE56QTRORm9pTENKcGMzTjFZVzVqWlVSaGRHVWlPaUl5TURJMExUQTVMVEUzVkRFeU9qSXdPakE0TGpRd09EVXhOekE0TkZvaUxDSnBjM04xWlhJaU9pSmthV1E2Wld4emFUcFdRVlJGVXkxUk1EQXdNREF3TUVvaUxDSjJZV3hwWkVaeWIyMGlPaUl5TURJMExUQTVMVEUzVkRFeU9qSXdPakE0TGpRd09EVXhOekE0TkZvaWZTd2lhblJwSWpvaU5qTTBNekEwT0RNdFpqQTRaQzAwTm1abUxUa3dNell0WVdZM09XRXdORGd3T0dZMUluMC5aS01NUzAxSWJQcG8xQlBMUUNZcGhiOTNHSmlNSjNmN0E3VzRIbzhJU2FDa3hoTkpsOWIwS19IcVBGSHRxNGpRa1BrNjdINnloenRYeWYxbXFqOFJZaWlDd1p6aGpsSmxFQzBmai1GUHpyN0RUdEQwV2dtN0psZ3laNnVRNU1lSkdCTk9xeGdDbm1GNktXUnplQUN1OGUweXVfSTMzLU4yVW14c3dJS0dqLVJDR0EtSWk1T0psMmh1UG5GN1RZMmlvVUl4UWJXYk9LbGFYUkdRUUNzSVZhTnp3WEJnNTFFTTRHSXByNUVqMVdJNWd4VFVvRGNCQlZHeWs4TnpWeUdidWo5UWZkelo3WGpWNFl3NEtTTXZoX0FRODM3VlVCTFpvRDVhM3dyb2dKZXZKMXBneWptTkhPNUpoV2l1bjFPYkZNMm9kVlk4VDljWVUzM0FsU3hZenZCWWNueEd5N3VVQ1hxcC1QMjFIaXAxYU96WXk2QnJlcnlHVzhpTTFqU0xWeGRZUGt3QXNxNGdZUEN4d29fZ0sweUFmVmdfQWxSNU9NSkowaDM0d21kNzhGMVcwSTRLZEowdEhRWDVjLTJOMlJSQTFxNHgyRlpodW5oOV9OdWcxdmlpMWRSX2tDaEpaeTFNaWtfaGpZZXdqbTFTc3djVE0xTnZVZFYxYjIwelJKck1udjJTeDdIUlRDY3QwYnc5dVhXaU1NdEdDelhmY3VrM0F5UkRWd2txblBvUk4wRURnaE11N3d0c0M3VE5UUDk4S2drSmlMRXROOUh1bE5Ga1B2Z1lUUmx0QUJBM3BoR044dlVlbl9zU0NIVXBTOUxHLTI0YUtuVHc4U1RDdm5LOUdWMTk3aXJQV2RMTGNMVEk4emtBNVQzdnlCTjFwbVNTU3hOblFKWSJdfSwiZXhwIjoxNzMwMDA1OTE3LCJpYXQiOjE3MjY2NDU5MTcsImp0aSI6InVybjp1dWlkOmNjYTI5ZGE1LTVkM2YtNDMzMC1iNDRhLTFiMjBmYzFlODk5NyJ9.KlnIMNl7Wg-rpFIyg72dwzgS6ClD34dRHsNH7lEadBh-cpeetS7cVaiRTNYUDLLklnnhjTkVP3gLxQGbI50wTA                """;
        byte[] publicKeyBytes = getPublicKeyBytesFromDid("did:key:zDnaeV2n9nK8Uabvcgaa9XdJkdbqUahLLpbt4WqS83F8pPCv7");
        try {
            // Set the curve as secp256r1
            ECCurve curve = new SecP256R1Curve();
            BigInteger x = new BigInteger(1, Arrays.copyOfRange(publicKeyBytes, 1, publicKeyBytes.length));
            // Recover the Y coordinate from the X coordinate and the curve
            BigInteger y = curve.decodePoint(publicKeyBytes).getYCoord().toBigInteger();
            ECPoint point = new ECPoint(x, y);
            // Fetch the ECParameterSpec for secp256r1
            ECNamedCurveParameterSpec ecSpec = ECNamedCurveTable.getParameterSpec("secp256r1");
            ECNamedCurveSpec params = new ECNamedCurveSpec("secp256r1", ecSpec.getCurve(), ecSpec.getG(), ecSpec.getN());
            // Create a KeyFactory and generate the public key
            KeyFactory kf = KeyFactory.getInstance("EC");
            java.security.spec.ECPublicKeySpec pubKeySpec = new java.security.spec.ECPublicKeySpec(point, params);
            PublicKey publicKey = kf.generatePublic(pubKeySpec);
            // Parse the JWT and create a verifier
            SignedJWT signedJWT = SignedJWT.parse(jwt);
            ECDSAVerifier verifier = new ECDSAVerifier((ECPublicKey) publicKey);
            // Verify the signature
            if (!signedJWT.verify(verifier)) {
                throw new JWTVerificationException("Invalid JWT signature");
            }
        } catch (Exception e) {
            throw new RuntimeException("JWT signature verification failed.", e);
        }
    }


    public byte[] getPublicKeyBytesFromDid(String did) {
        if (!did.startsWith("did:key:")) {
            throw new IllegalArgumentException("Unsupported DID type. Only did:key is supported for the moment.");
        }
        // Remove the "did:key:" prefix to get the actual encoded public key
        String encodedPublicKey = did.substring("did:key:".length());
        // Decode the public key from its encoded representation
        return decodePublicKeyIntoBytes(encodedPublicKey);
    }

    private byte[] decodePublicKeyIntoBytes(String publicKey) {
        // Remove the prefix "z" to get the multibase encoded string
        if (!publicKey.startsWith("z")) {
            throw new IllegalArgumentException("Invalid Public Key.");
        }
        String multibaseEncoded = publicKey.substring(1);
        // Multibase decode (Base58) the encoded part to get the bytes
        byte[] decodedBytes = io.github.novacrypto.base58.Base58.base58Decode(multibaseEncoded);
        // Multicodec prefix is fixed for "0x1200" for the secp256r1 curve
        int prefixLength = 2;
        // Extract public key bytes after the multicodec prefix
        byte[] publicKeyBytes = new byte[decodedBytes.length - prefixLength];
        System.arraycopy(decodedBytes, prefixLength, publicKeyBytes, 0, publicKeyBytes.length);
        return publicKeyBytes;
    }

}